# FEATURE-BRIEF: User Authentication

> **Product:** Prebloom  
> **Generated by:** BMAD Council (8 agents)  
> **Date:** 2026-02-22

---

## Executive Summary

Production-ready, frictionless authentication for Prebloom using **Supabase Auth** with **Google OAuth primary** and **Magic Link fallback**. No passwords. Enables user history, future billing (Stripe), and 5-10x higher lifetime value through user retention.

**Key principle:** Auth happens *after* value delivery â€” "Save this analysis?" not "Sign up to use."

---

## 1. Analysis Summary

### Value Proposition
- **Anonymous friction paradox** â€” Users get great analysis but lose it forever
- **Zero relationship building** â€” Can't learn patterns or personalize
- **Revenue ceiling** â€” No path to monetization without identity

### Business Impact
- Authenticated users = **5-10x higher LTV**
- Enables freemium model (3 free evals/month â†’ paid)
- Creates **switching costs** (history = moat)

### Critical UX Insight
> "Pre-analysis signup = high drop-off. Post-analysis 'Save this?' = natural conversion moment."

---

## 2. Product Requirements

### Auth Method
| Method | Role | Why |
|--------|------|-----|
| **Google OAuth** | Primary | 90% of users have accounts, 1-click |
| **Magic Link** | Secondary | Privacy-conscious users, no passwords |
| **Passkeys** | Future (v2) | ~70% browser support, add later |

### User Stories
- As a first-time user, I want to sign up in <10 seconds
- As a returning user, I want my evaluation history accessible
- As a busy entrepreneur, I want to stay logged in across sessions

### Acceptance Criteria
- [ ] Sign-up in â‰¤3 clicks
- [ ] Anonymous evaluations can be claimed by new accounts
- [ ] Auto-login on return (remember me)
- [ ] "Continue as Guest" preserved
- [ ] Account deletion removes all data (GDPR)

### Success Metrics
- >60% signup rate among users who complete an evaluation
- >40% return user rate
- <500ms auth response time
- Zero security incidents in first 90 days

---

## 3. Architecture

### System Components
```
Frontend:
â”œâ”€â”€ AuthContext.tsx â€” Auth state management
â”œâ”€â”€ LoginModal.tsx â€” Social + magic link UI
â”œâ”€â”€ AuthGuard.tsx â€” Route protection
â””â”€â”€ supabase.ts â€” Client singleton

Backend:
â”œâ”€â”€ middleware/auth.js â€” JWT validation
â”œâ”€â”€ routes/auth.js â€” Callbacks, profile
â””â”€â”€ services/supabaseAdmin.js â€” Server client
```

### Data Model
```sql
-- user_profiles (extends Supabase auth.users)
CREATE TABLE user_profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id),
  email TEXT NOT NULL,
  full_name TEXT,
  avatar_url TEXT,
  stripe_customer_id TEXT,  -- Ready for billing
  subscription_status TEXT DEFAULT 'free',
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Link evaluations to users
ALTER TABLE projects ADD COLUMN user_id UUID REFERENCES auth.users(id);
ALTER TABLE evaluations ADD COLUMN user_id UUID REFERENCES auth.users(id);

-- Row Level Security
ALTER TABLE projects ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users see own projects" ON projects
  FOR SELECT USING (auth.uid() = user_id OR user_id IS NULL);
```

### Auth Flow
```
User clicks "Sign In"
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [Google] [Email]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
    â”‚           â”‚
    â–¼           â–¼
 OAuth       Magic Link
 Flow        (15-min expiry)
    â”‚           â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
   Session Created
   (JWT + httpOnly cookie)
          â”‚
          â–¼
   Dashboard / History
```

---

## 4. Security Requirements

### P0 â€” Launch Blockers
- [ ] Rate limiting: 3 attempts/5min per email
- [ ] Magic links: 15-min expiry, single-use only
- [ ] HTTPS + HSTS mandatory
- [ ] Cookies: `httpOnly`, `secure`, `sameSite: strict`
- [ ] JWT: RS256 algorithm (NOT HS256)
- [ ] RLS policies tested and **restrictive by default**
- [ ] CSRF protection on state-changing operations
- [ ] Input validation on email
- [ ] Security headers (CSP, X-Frame-Options)
- [ ] No secrets in code/env files

### Token Architecture
```javascript
// Access token: 15-min expiry, memory + httpOnly cookie
// Refresh token: 7-day, httpOnly cookie only
// Fingerprint: secure cookie for session binding

res.cookie('refreshToken', token, {
  httpOnly: true,
  secure: true,
  sameSite: 'strict',
  maxAge: 7 * 24 * 60 * 60 * 1000
});
```

### NEVER Do This
```javascript
localStorage.setItem('token', jwt);  // XSS = token theft
cookie = 'token=' + jwt;              // Missing httpOnly
res.json({ token: jwt });             // Token in response body
```

### P1 â€” Within 30 Days
- [ ] Session anomaly detection (IP/location)
- [ ] Email notification for new device login
- [ ] Audit logging for auth events
- [ ] JWT key rotation mechanism

---

## 5. UX Design

### Philosophy: "Authentication by Stealth"
Users don't *sign up* â€” they just continue their journey.

### Trigger Point
```
[Explore] â†’ [Validate] â†’ [See Results] â†’ [Auth Prompt] â†’ [Return]
                                    â†‘
                          "Save this to your garden?"
```

### Post-Analysis Prompt
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ðŸŒ± Save this to your idea garden?  â”‚
â”‚                                     â”‚
â”‚  [email@domain.com        ] ðŸ“§      â”‚
â”‚  [Your name (optional)    ] ðŸ‘¤      â”‚
â”‚                                     â”‚
â”‚  [ðŸŒ± Save & Continue] [Skip for now]â”‚
â”‚                                     â”‚
â”‚  â–¸ No password â€¢ Takes 5 seconds    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### States & Copy (Tulip Theme)
- Signing up: "ðŸŒ± Planting your account..."
- Signing in: "ðŸŒ· Welcome back..."
- Error: "Our tulips are investigating! ðŸŒ·"

---

## 6. Implementation Plan

### Effort Estimate
**16-24 hours** (Medium-High complexity)

### Phases
1. **Backend auth foundation** (4-6h)
   - Supabase admin client
   - Auth middleware
   - Token validation helpers

2. **Frontend auth components** (6-8h)
   - AuthContext + useAuth hook
   - LoginModal (social + magic link)
   - AuthGuard for protected routes

3. **API integration** (3-4h)
   - Auth headers on all requests
   - User context in routes
   - Profile endpoints

4. **Database migration** (2-3h)
   - Add user_id columns
   - RLS policies
   - user_profiles table

5. **Testing & edge cases** (3-5h)

### Files to Create
- `frontend/src/contexts/AuthContext.tsx`
- `frontend/src/components/Auth/LoginModal.tsx`
- `frontend/src/hooks/useAuth.ts`
- `frontend/src/lib/supabase.ts`
- `src/middleware/auth.js`
- `src/routes/auth.js`
- `src/services/supabaseAdmin.js`

### Files to Modify
- `frontend/src/App.tsx` â€” Add AuthProvider
- `frontend/src/api/api.ts` â€” Add auth headers
- `src/app.js` â€” Add auth middleware
- `src/routes/projects.js` â€” User filtering

---

## 7. Test Strategy

### Critical Tests (P0)
1. Magic link email delivery
2. Session validation (JWT edge cases)
3. Anonymous flow preservation â† **regression risk #1**
4. OAuth callback handling
5. RLS policy enforcement

### Security Tests
- JWT manipulation (signature tampering)
- Cross-user data access attempts
- Session fixation prevention
- Rate limit enforcement

### Edge Cases
- Token expires mid-request â†’ transparent refresh
- Back button after logout â†’ no cached data
- Same email across providers â†’ single linked account

### E2E Flows
- New user magic link signup
- Google OAuth login
- Anonymous â†’ authenticated claim
- Session persistence across reload

---

## 8. Deployment

### Environment Variables
```bash
SUPABASE_JWT_SECRET=<from-dashboard>
SUPABASE_SITE_URL=https://prebloom.com
SUPABASE_REDIRECT_URL=https://prebloom.com/auth/callback
SESSION_SECRET=<openssl rand -hex 32>
COOKIE_DOMAIN=prebloom.com
COOKIE_SECURE=true
```

### Rollout Strategy
1. **Feature flag deploy** (`ENABLE_AUTH=false`)
2. **Enable for testing** (flip flag)
3. **Database migration** (RLS policies)
4. **Full rollout**

### Rollback Plan (<5 minutes)
```bash
# Disable auth
echo "ENABLE_AUTH=false" >> .env
docker compose restart backend

# If RLS breaks queries
ALTER TABLE projects DISABLE ROW LEVEL SECURITY;
```

### Monitoring
- Failed login spikes (>10/min from single IP)
- Auth service health checks
- JWT verification errors
- CORS violations

---

## Open Questions

1. **Email provider for magic links?** â€” Supabase includes 3,500/month free
2. **Add GitHub OAuth?** â€” Evaluate post-launch based on user segment
3. **Session duration?** â€” Recommend 7 days with refresh
4. **Anonymous data retention?** â€” How long to keep unclaimed evaluations?

---

## Definition of Done

- [ ] All P0 security requirements met
- [ ] Acceptance criteria verified
- [ ] E2E tests passing
- [ ] Security tests passing
- [ ] Anonymous flow still works
- [ ] Feature flag rollout complete
- [ ] Monitoring dashboards configured
- [ ] Documentation updated

---

## Next Steps

1. **Configure Supabase Auth** in dashboard (enable email + Google providers)
2. **Register Google OAuth app** in Google Cloud Console
3. **Create database migration** for user_profiles + RLS
4. **Build AuthContext** and LoginModal components
5. **Add auth middleware** to backend
6. **Write E2E tests** for critical flows
7. **Deploy with feature flag** disabled
8. **Test in staging**, then flip to production

---

*Raw agent outputs available in `docs/bmad/raw/`*
